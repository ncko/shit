#!/usr/bin/env bash

bold=$(tput bold)
normal=$(tput sgr0)

function check() {
  if [ $# -eq 0 ]; then
    local category_item=`get-category-and-item`
    local category=`echo $category_item | cut -d % -f 1`
    local item=`echo $category_item | cut -d % -f 2`
    print-item "$category" "$item"
    exit 0
  fi

  case $1 in
    add) add;;
    edit) edit;;
    -h) help;;
    --help) help;;
    \?) help && exit 1;
  esac
}

function edit() {
  local category_item=`get-category-and-item`
  local category=`echo $category_item | cut -d % -f 1`
  local item=`echo $category_item | cut -d % -f 2`

  tmp=$(mktemp)
  cat data.json | jq --arg c "$category" --arg i "$item" '.[$c][$i]' | sed -e 's/^"//' -e 's/"$//' > $tmp
  vim $tmp

  cat data.json | jq --arg c "$category" --arg i "$item" --arg update "$(cat $tmp)" '.[$c][$i] = $update' > data.json
}

function add() {
  echo "adding"
}

function help() {
  echo "${bold}USAGE${normal}"
  echo "  shit <command> [flags]"
  echo ""
  echo "${bold}SUBCOMMANDS${normal}"
  echo "  add:    add a new shit"
  echo "  edit:   edit an existing shit"
  echo ""
  echo "${bold}FLAGS${normal}"
  echo "  --help, -h    show this message"
  echo ""
  echo "${bold}EXAMPLES${normal}"
  echo "Find an existing shit"
  echo "  $ shit"
  echo ""
  echo "Edit an existing shit"
  echo "  $ shit edit"
  echo ""
  echo "Add a new shit"
  echo "  $ shit add --category bash --title \"display hello world message\" --shit \"echo Hello, World!\""
  echo ""
  echo "Adding can also be done with short flags"
  echo "  $ shit add -c bash -t \"display hello world message\" -s \"echo Hello, World!\""
  echo ""
  echo "${bold}FEEDBACK${normal}"
  echo "Open an issue at github.com/ncko/shit"
  echo ""
}

function get-category-and-item() {
  local category=`cat data.json | jq 'keys[]' | tr -d \" | fzf`
  local item=`cat data.json | jq --arg c $category '.[$c] | keys[]' | tr -d \" | fzf`
  echo $category%$item
}

function print-item() {
  cat data.json | jq --arg c "$1" --arg i "$2" '.[$c][$i]' | tr -d \"
}

check $@
